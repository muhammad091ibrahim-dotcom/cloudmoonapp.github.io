import{w as o,g as p}from"./CZfm6YAs.js";const y=o({message:"",show:!1,x:0,y:0});function L(n,e,s=2500){let a,t;e?{clientX:a,clientY:t}=e:typeof window<"u"&&(a=window.innerWidth/2,t=window.innerHeight/2),y.set({message:n,show:!0,x:a,y:t}),setTimeout(()=>{y.set({message:"",show:!1,x:0,y:0})},s)}const O="https://api.prod.cloudmoonapp.com";async function c(n,e={}){const s=new URL(O+n),a=new Headers(e.headers);s.searchParams.set("device_type","web");let t="";crypto.randomUUID?t=crypto.randomUUID():t=U(),s.searchParams.set("query_uuid",t);let r=t;{r=localStorage.getItem("device_id"),r||(r=t,localStorage.setItem("device_id",r));const m=(navigator.language||navigator.userLanguage).split("-")[1]||"";a.set("X-User-Locale",m)}s.searchParams.set("device_id",r);const u=p(d);if(u!=null&&u.token&&a.set("X-User-Token",u.token),!a.get("X-User-Language")){const g=p(S)??"en";a.set("X-User-Language",g)}a.set("Content-Type","application/json");const i=await fetch(s.toString(),{...e,headers:a});if(!i.ok)throw new Error(`fetch error: ${i.status} - ${i.statusText}`);if((await i.clone().json()).code=="40001"){N();return}return i}function U(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}const v=o({android_id:null,package_name:null,expired_at:null,level:null,is_paid:!1,time_left_set:null,use_time_type:0,time_left_sec:0,is_subscription:!1,backup_time:null});async function x(){var n,e;try{const a=await(await c("/phone/list")).json();if(a.code===0&&((e=(n=a.data)==null?void 0:n.list)==null?void 0:e.length)>0){const t=a.data.list[0];v.set({android_id:t.android_id,package_name:t.package_name,expired_at:t.expired_at,level:t.level,is_paid:t.is_paid,time_left_set:t.time_left_set,time_left_sec:t.time_left_sec,use_time_type:t.use_time_type,is_subscription:t.is_subscription,backup_time:t.backup_time})}}catch(s){console.error("Failed to fetch phone data:",s)}}let _;async function C(){f(),await x(),_=setInterval(()=>{x()},5e3)}function f(){_&&(clearInterval(_),_=null)}async function G(n,e){const s=p(v);let a=0;try{let t=localStorage.getItem("selectedServer")||0;if(a=parseInt(t),a===0){L("Please select a server",null);return}const r=p(S)||"en",i=(navigator.language||navigator.userLanguage).split("-")[1]||"",l=await(await c("/phone/connect",{method:"POST",body:JSON.stringify({android_id:s.android_id,game_name:e,screen_res:"720x1280",server_id:a,params:JSON.stringify({language:r,locale:i.toLowerCase()})})})).json();if(l.code===0){const{android_instance_id:g,coordinator_host:m,position:I,waiting_time:b,priority_queue_length:P,priority_waiting_time:D}=l.data;return{android_instance_id:g,coordinator_host:m,position:I,waiting_time:b,err_code:l.code,priority_queue_length:P,priority_waiting_time:D,message:l.message}}else return{android_instance_id:null,coordinator_host:null,position:null,waiting_time:null,priority_queue_length:0,priority_waiting_time:0,err_code:l.code,message:l.message}}catch(t){throw console.error("Error connecting phone:",t),t}}const h=o({picture:null,user_id:null,name:null,email:null,is_set_pwd:!1}),q=o(!1);async function T(){try{const e=await(await c("/user/info")).json();e.code===0&&h.set({picture:e.data.picture,user_id:e.data.user_id,name:e.data.name,email:e.data.email,is_set_pwd:e.data.is_set_pwd})}catch(n){console.error("Failed to fetch user data:",n)}}async function E(n){try{const s=await(await c("/user/set_pwd",{method:"POST",body:JSON.stringify({password:n})})).json();return s.code===0&&await T(),s}catch(e){return console.error("Failed to set Pwd:",e),null}}const j=o({selectedGameFilter:"all"}),X=o(!1);async function A(){try{return await(await c("/game/reset_all",{method:"POST"})).json()}catch(n){return console.error("Failed to clear all game cache:",n),null}}function w(n,e={}){let s;h.subscribe(t=>{s=t==null?void 0:t.user_id})();const a=s?{user_id:s,...e}:{...e};gtag("event",n,a)}const d=o({userId:null,token:null,init:!1}),S=o("en");function H(n){const e=document.createElement("script");return e.src="https://accounts.google.com/gsi/client",e.async=!0,e.defer=!0,document.head.appendChild(e),new Promise(s=>{e.onload=()=>{google.accounts.id.initialize({client_id:n,callback:J,auto_select:!1,cancel_on_tap_outside:!1}),s()}})}function z(){var e;const n=document.createElement("div");document.body.appendChild(n),google.accounts.id.renderButton(n,{theme:"outline",size:"large",type:"standard"}),(e=n.querySelector('[role="button"]'))==null||e.click(),n.style="display: none"}async function J(n){const e=n.credential;try{const a=await(await c("/login/google",{method:"POST",body:JSON.stringify({google_id_token:e})})).json();if(a.code===0){const t={userId:a.data.user_id,token:a.data.token,init:!0};return w("sign_in"),d.set(t),localStorage.setItem("userData",JSON.stringify(t)),!0}else return console.error("Login failed:",a),!1}catch(s){return console.error("Login error:",s),!1}}async function B(n,e){try{const a=await(await c("/login/pwd",{method:"POST",body:JSON.stringify({email:n,password:e})})).json();if(a.code===0){const t={userId:a.data.user_id,token:a.data.token,init:!0};return w("sign_in_by_pwd"),d.set(t),localStorage.setItem("userData",JSON.stringify(t)),a}else return console.error("Login failed:",a),a}catch(s){return console.error("Login error:",s),null}}function N(){w("sign_out"),d.set({userId:null,token:null,init:!0}),h.set({picture:null,user_id:null,name:null}),f(),j.set({selectedGameFilter:"all"}),localStorage.removeItem("userData")}function R(){{const n=localStorage.getItem("userData");if(n){const e=localStorage.getItem("selectedServer");if(!e||parseInt(e)===0){f(),localStorage.removeItem("userData");return}d.set(JSON.parse(n))}d.update(e=>({...e,init:!0}))}}export{d as a,G as b,c,h as d,y as e,L as f,N as g,z as h,H as i,R as j,T as k,B as l,C as m,f as n,A as o,v as p,E as q,j as r,q as s,w as t,S as u,X as v};
