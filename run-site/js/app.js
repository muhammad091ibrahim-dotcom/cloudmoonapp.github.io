const params=new URLSearchParams(window.location.search);import gameConfig from "./gameConfig.js";window.App=new Vue({el:"#app",data:{inputTextShow:!1,inputTextStr:"",zoom:!0,socket:null,game:params.get("game"),userId:params.get("userid"),codec:params.get("codec"),videoHeight:nenly_screen_height,videoWidth:nenly_screen_width,screenHeight:nenly_screen_height,screenWidth:nenly_screen_width,bitRate:params.get("bit_rate")||0,maxScreenWidth:1280,dataChannel:null,remoteStream:null,pc:null,pcConfiguration:{iceServers:[{urls:nenly_turn_server,username:"diccarp",credential:"diccarp"},{urls:"stun:stun.l.google.com:19302"},{urls:"turn:stun.nenly.cn:53006",username:"diccarp",credential:"diccarp"}],bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},initParams:{screenWidth:nenly_screen_height,screenHeight:nenly_screen_width,language:params.get("language")||"en",nenlyGenerateUserId:"true"===nenly_generate_userid,nenlyEsUrl:nenly_es_url,nenlyRotateScreen:"true"===nenly_rotate_screen,enableFullScreen:"true"===nenly_enable_fullscreen,nenlyRealIp:nenly_RealIp,gameName:nenly_game_name,showVconsole:"true"===nenly_show_vconsole,env:nenly_env,sendMetric:"true"===nenly_send_metric,maxResolution:"true"===nenly_max_resolution,showLoading:"true"===nenly_show_loading,lockMouse:params.get("lock_mouse")||"true"===nenly_lock_mouse,metricUrl:nenly_metric_url,logLevel:nenly_log_level,statInterval:params.get("stat_interval")||3e3},rotation:0,rotate:!1,isHorizontal:!1,direction:2,enableTouch:!0,showPlayBtn:!1,isRotate:!1,dataChannelStartTimestamp:0,dataChannelDelay:0,showPing:!0,getout:!1,openPageTime:0,loadingDoneTime:0,streamingConnectedTime:0,sessionFirstScreenWidth:0,sessionFirstScreenHeight:0,steps:[],sendResizeJob:null,resizeCount:0,videoStats:null,sendCount:0,podName:"",sendStartGame:!1,clientRegisterTimer:null,muteBtn:"toggleVideo>on",lockMouseTimer:null,cursorHide:!1,cursorLock:!1,lastKeyDownCode:0,lastKeyDownTime:0,exitingPointerLock:!1,keyDownMap:{},timeDiff:0,resizeGamePad:!1,alwaysSendMove:"true"===params.get("always_send_move"),codec_type:params.get("always_send_move")||0,touchIdMap:new Map,touchCounter:11,showKeyboard:!0,center:{x:0,y:0},dRadius:120,dStep:4,leftRockerStart:!1,leftRockerEnd:!0,leftRockerPosition:{x:0,y:0},leftRockerPressedKeys:{},rightRockerStart:!1,rightRockerEnd:!0,rightRockerPosition:{x:0,y:0},rightRockerPressedKeys:{},dEyeCenter:{x:0,y:0},dEyePosition:{x:0,y:0},dEyeRadius:350,startTime:null,liveTimeSet:[],gameConfig:{},moveX:0,moveY:0,pointerLockStart:!1,resetMoveTimer:null,scaleValue:1,ballDragging:!1,ballPosition:{x:0,y:document.documentElement.clientHeight/2},openMenu:!1,isFullScreen:!1,isRotateScreen:!1,podLocale:0,androidInstance:{},checkGame:null,supportPointerLock:!1,mouseSensitivity:1,iconRotate:!1,keyRotate:!1,oldOffer:null,oldAnswer:null,editLeftPosition:!1,utcDate:""},watch:{isRotateScreen(e){this.direction=1===this.direction?0:1,this.changeOrientation(this.direction)},direction(e){},isFullScreen(e){e?this.fullScreen():this.exitFullScreen()}},computed:{centerXPercent:{get(){return Math.round(this.center.x/1280*1e3)/10},set(e){const t=Math.max(0,Math.min(100,Math.round(10*e)/10));this.center.x=Math.round(t/100*1280)}},centerYPercent:{get(){return Math.round(this.center.y/720*1e3)/10},set(e){const t=Math.max(0,Math.min(100,Math.round(10*e)/10));this.center.y=Math.round(t/100*720)}}},mounted(){let e=this;if(log.setDefaultLevel(parseInt(this.initParams.logLevel)),e.gameConfig=gameConfig,document.getElementById("canvasCoc").addEventListener("mouseleave",(t=>{e.mouseleave(t)})),this.getUTCDate(),setInterval((()=>{this.getUTCDate()}),1e3),e.initParams.showVconsole&&new VConsole,"false"!==this.initParams.gameName&&null==this.game&&(this.game=this.initParams.gameName),this.checkGame=this.game,this.checkGame.includes("YZGAME")&&(this.checkGame="YZGAME"),this.sendMetric("open_page",{game:this.game,env:this.initParams.env}),this.openPageTime=Date.now(),loading(),document.documentElement.clientWidth>document.documentElement.clientHeight?this.ballPosition={x:0,y:document.documentElement.clientHeight/2}:this.ballPosition={x:document.documentElement.clientWidth/2,y:0},this.pushSteps("Welcome, "+this.userId),this.streamingOn=!1,this.getout=!1,this.initParams.maxResolution){0===this.sessionFirstScreenWidth&&(this.sessionFirstScreenWidth=document.documentElement.clientWidth,this.sessionFirstScreenHeight=document.documentElement.clientHeight);let e=this.sessionFirstScreenWidth,t=this.sessionFirstScreenHeight;if(e<t&&(t=this.sessionFirstScreenWidth,e=this.sessionFirstScreenHeight),this.screenHeight=e,this.screenWidth=t,this.initParams.screenWidth=e,this.initParams.screenHeight=t,e>this.maxScreenWidth){let i=this.maxScreenWidth,s=Math.floor(this.maxScreenWidth/e*t);this.screenHeight=i,this.screenWidth=s,this.initParams.screenWidth=i,this.initParams.screenHeight=s}}if(this.initParams.nenlyGenerateUserId&&!this.userId)try{let e=window.localStorage;this.userId=e.userId?e.userId:this.guid(),e.setItem("userId",this.userId)}catch(e){log.info("unsupported localStorage"),this.userId=this.guid()}this.supportPointerLock=this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].pointerLock||!1,this.gameConfig[this.checkGame]&&(this.center=this.gameConfig[this.checkGame].center),this.connectStreaming(),window.sendDataChannelMessage=this.sendDataChannelMessage,window.handleDCMessage=this.handleDCMessage,window.pc=this.pc,window.datachannel=this.dataChannel,(!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)||e.initParams.enableFullScreen)&&(this.showPlayBtn=!0),this.videoWidth=this.width,this.videoHeight=Math.round(this.width/this.screenWidth*this.screenHeight);let t=document.documentElement.clientWidth,i=document.documentElement.clientHeight;e.initParams.nenlyRotateScreen?e.direction=t>i?1:0:e.direction=1,e.changeOrientation(e.direction),"onorientationchange"in window&&(window.onorientationchange=()=>{window.dispatchEvent(new Event("resize"))}),"screen"in window&&"orientation"in window.screen&&(window.screen.orientation.onchange=()=>{window.dispatchEvent(new Event("resize"))}),window.onresize=()=>{e.screenDirection()},window.onbeforeunload=()=>{e.sendES("user_interaction","window_closing/tab_closing")},window.oncontextmenu= e=>{e.preventDefault()},document.addEventListener("pointerlockchange",this.pointerLockChange),document.addEventListener("mozpointerlockchange",this.pointerLockChange),document.addEventListener("webkitpointerlockchange",this.pointerLockChange),document.addEventListener("fullscreenchange",(()=>{this.isFullScreen=!!this.checkFullScreen()})),window.onblur=()=>{for(let e in this.keyDownMap)if(this.keyDownMap[e]){let t="touch>KeyUp:"+e;1!==e.length&&(t="touch>KeyUpCmd:"+e),this.sendDataChannelMessage(t),this.keyDownMap[e]=!1}for(let e in this.leftRockerPressedKeys){delete this.leftRockerPressedKeys[e.toLowerCase()];const t=document.querySelector(`.keyboard-key-${e.toLowerCase()}`);t&&t.classList.remove("keyboard-key-press")}if(0===Object.keys(this.leftRockerPressedKeys).length){if(!this.gameConfig[this.checkGame])return;let e=this.center;this.leftRockerEnd||(this.sendDataChannelMessage(`touch>Touch end:10,${e.x+Math.floor(this.leftRockerPosition.x)},${e.y+Math.floor(this.leftRockerPosition.y)}`),this.leftRockerPosition={x:0,y:0},this.leftRockerStart=!1,this.leftRockerEnd=!0)}for(let e in this.rightRockerPressedKeys){delete this.rightRockerPressedKeys[e.toLowerCase()];const t=document.querySelector(`.keyboard-key-${e.toLowerCase()}`);t&&t.classList.remove("keyboard-key-press")}if(0===Object.keys(this.rightRockerPressedKeys).length){if(!this.gameConfig[this.checkGame])return;let e=this.gameConfig[this.checkGame].rightCenter;this.rightRockerEnd||(this.sendDataChannelMessage(`touch>Touch end:11,${e.x+Math.floor(this.rightRockerPosition.x)},${e.y+Math.floor(this.rightRockerPosition.y)}`),this.rightRockerPosition={x:0,y:0},this.rightRockerStart=!1,this.rightRockerEnd=!0)}};const s=this.gameConfig[this.checkGame];this.dEyeRadius=s?.rightRockerRadius??350,this.gameLoop()},methods:{translationLocation(e, t){if(e.location&&""!==e.location)return e.location;if(e.coordinate&&""!==e.coordinate&&"0,0"!==e.coordinate){const[t,i]=e.coordinate.split(",").map(Number);return`left: ${t/1280*100}%; bottom: ${(720-i)/720*100}%;`}return e.location},translationCenterLocation:(e, t)=>`left: ${e.x/1280*100}%; bottom: ${(720-e.y)/720*100}%;`,checkFullScreen:()=>null!==document.fullscreenElement,ballClick(){this.openMenu=!this.openMenu},ballStart(e){this.ballDragging=!0;const t=e.touches?e.touches[0].clientX:e.clientX,i=e.touches?e.touches[0].clientY:e.clientY,s=t-this.ballPosition.x,o=i-this.ballPosition.y,n= e=>{if(!this.ballDragging)return;const t=e.touches?e.touches[0].clientX:e.clientX,i=e.touches?e.touches[0].clientY:e.clientY,n=window.innerWidth-40,r=window.innerHeight-40;this.ballPosition.x=Math.max(0,Math.min(t-s,n)),this.ballPosition.y=Math.max(0,Math.min(i-o,r))},r= e=>{this.ballDragging=!1;const s=e.changedTouches?e.changedTouches[0].clientX:e.clientX,o=e.changedTouches?e.changedTouches[0].clientY:e.clientY,a=Math.abs(s-t),h=Math.abs(o-i);a<5&&h<5&&this.ballClick(),window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",r),window.removeEventListener("touchmove",n),window.removeEventListener("touchend",r)};window.addEventListener("mousemove",n),window.addEventListener("mouseup",r),window.addEventListener("touchmove",n,{passive:!1}),window.addEventListener("touchend",r)},isMobile:()=>/Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent),gameLoop(){this.updateLeftPosition(),this.updateRightPosition(),requestAnimationFrame(this.gameLoop)},updateLeftPosition(){if(this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].supportLeftRocker||!1){let e=this.leftRockerPosition.x,t=this.leftRockerPosition.y,i=this.dStep;if(this.leftRockerPressedKeys.w&&(t-=i),this.leftRockerPressedKeys.s&&(t+=i),this.leftRockerPressedKeys.a&&(e-=i),this.leftRockerPressedKeys.d&&(e+=i),!this.gameConfig[this.checkGame])return;let s=this.center;const o=e,n=t;let r=!1;if(Math.sqrt(o*o+n*n)>this.dRadius){r=!0;const i=Math.atan2(n,o);e=this.dRadius*Math.cos(i),t=this.dRadius*Math.sin(i)}if(Math.floor(e)===Math.floor(this.leftRockerPosition.x)&&Math.floor(t)===Math.floor(this.leftRockerPosition.y))return;if(r||(e>t?t+=Math.random()<.5?-1:1:e+=Math.random()<.5?-1:1),this.leftRockerPosition.x=e,this.leftRockerPosition.y=t,Object.keys(this.leftRockerPressedKeys).length>0){if(!this.leftRockerStart){const e=`touch>Touch start:10,${s.x+this.leftRockerPosition.x},${s.y+this.leftRockerPosition.y}`;this.sendDataChannelMessage(e),this.leftRockerStart=!0,this.leftRockerEnd=!1}const e=`touch>Touch move:10,${s.x+Math.floor(this.leftRockerPosition.x)},${s.y+Math.floor(this.leftRockerPosition.y)}`;this.sendDataChannelMessage(e)}}},updateRightPosition(){if(this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].supportRightRocker||!1){let e=this.rightRockerPosition.x,t=this.rightRockerPosition.y,i=this.dStep;if(this.rightRockerPressedKeys.z&&(t-=i),this.rightRockerPressedKeys.v&&(t+=i),this.rightRockerPressedKeys.x&&(e-=i),this.rightRockerPressedKeys.c&&(e+=i),!this.gameConfig[this.checkGame])return;let s=this.center;const o=e,n=t;let r=!1;if(Math.sqrt(o*o+n*n)>this.dRadius){r=!0;const i=Math.atan2(n,o);e=this.dRadius*Math.cos(i),t=this.dRadius*Math.sin(i)}if(Math.floor(e)===Math.floor(this.rightRockerPosition.x)&&Math.floor(t)===Math.floor(this.rightRockerPosition.y))return;if(r||(e>t?t+=Math.random()<.5?-1:1:e+=Math.random()<.5?-1:1),this.rightRockerPosition.x=e,this.rightRockerPosition.y=t,Object.keys(this.rightRockerPressedKeys).length>0){if(!this.rightRockerStart){const e=`touch>Touch start:11,${s.x+this.rightRockerPosition.x},${s.y+this.rightRockerPosition.y}`;this.sendDataChannelMessage(e),this.rightRockerStart=!0,this.rightRockerEnd=!1}const e=`touch>Touch move:11,${s.x+Math.floor(this.rightRockerPosition.x)},${s.y+Math.floor(this.rightRockerPosition.y)}`;this.sendDataChannelMessage(e)}}},pointerLock(){const e=document.getElementById("canvasCoc");document.pointerLockElement===e?(log.info("exitPointerLock"),document.exitPointerLock()):(log.info("requestPointerLock"),e.requestPointerLock())},exitPointerLock(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock()},pointerLockChange(){const e=document.getElementById("canvasCoc");document.pointerLockElement===e||document.mozPointerLockElement===e||document.webkitPointerLockElement===e?this.cursorLock=!0:(this.cursorLock&&(18!==this.lastKeyDownCode||(this.lastKeyDownCode=0)),this.cursorLock=!1,this.exitingPointerLock=!0,setTimeout((()=>{this.exitingPointerLock=!1}),100))},deleteSendText(){""===this.inputTextStr&&this.sendDataChannelMessage("touch>TextCmd:Backspace")},enterSendText(){""!==this.inputTextStr?this.sendText():this.sendDataChannelMessage("touch>TextCmd:Enter")},sendText(){this.sendDataChannelMessage("text>"+this.inputTextStr),this.inputTextStr="",this.$refs.input.focus()},sendMute(){"toggleVideo>on"===this.muteBtn?(this.sendDataChannelMessage(this.muteBtn),this.muteBtn="toggleVideo>off"):(this.sendDataChannelMessage(this.muteBtn),this.muteBtn="toggleVideo>on")},sendES(e, t){let i={};i.type=e,i.ts=(new Date).getTime()+"",i.user_id=this.userId,"user_interaction"===e?(i.action=t,"connection_error"===t?(!1===this.streamingOn&&(i.action="connection_timeout"),i.steps=this.steps):"window_resizing"===t&&(i.resolution=document.documentElement.clientWidth+"x"+document.documentElement.clientHeight)):"rtc_client_metrics"===e&&(i.metrics=this.videoStats,this.sendCount++,i.count=this.sendCount),this.initParams.sendMetric&&""!==this.initParams.nenlyEsUrl&&axios.put("https://"+this.initParams.nenlyEsUrl,i)},sendMetric(e, t){this.initParams.sendMetric&&""!==this.initParams.metricUrl&&axios.post("https://"+this.initParams.metricUrl+"/v1/"+e,t)},getSocketUrl(){const e=new URLSearchParams(window.location.search);if(this.coordinator_host="",this.android_instance_id="",this.userId="",this.game="",this.androidInstance=null,e.has("userid")&&e.has("android_instance_id")&&e.has("game")){const t=e.get("coor_url");if(t&&(this.coordinator_host=t),this.android_instance_id=e.get("android_instance_id"),this.userId=e.get("userid"),this.game=e.get("game"),this.android_instance_id)try{this.androidInstance=JSON.parse(atob(this.android_instance_id)),this.androidInstance&&""===this.coordinator_host&&(this.coordinator_host=this.androidInstance.coorUrl)}catch(e){}}return this.coordinator_host||`https://${window.location.hostname}`},screenDirection(){let e=this;setTimeout((()=>{e.resizeCount++,e.resizeCount>1&&(clearTimeout(e.sendResizeJob),e.sendResizeJob=setTimeout((()=>{e.sendES("user_interaction","window_resizing")}),1e3)),e.changeOrientation(e.direction)}),100)},reportStates(){this.dataChannelStartTimestamp=(new Date).getTime(),null!=this.dataChannel&&"open"===this.dataChannel.readyState&&this.dataChannel.send("stats>"),setTimeout((()=>{this.reportStates()}),this.initParams.statInterval)},adjustPlayoutDelayFromStats(e){const t=e.jitter??1,i=e.retransmittedPacketsReceived??0,s=e.packetsReceived??1,o=e.jitterBufferEmittedCount??1,n=e.jitterBufferMinimumDelay??0,r=s>0?i/s:1,a=o>0?n/o*1e3:100;let h=.2;h=t<.005&&r<.05&&a<70?.04:t<.01&&r<.1&&a<100?.1:.2;for(const e of this.pc.getReceivers())void 0!==e.jitterBufferTarget&&(e.jitterBufferTarget=h),void 0!==e.playoutDelayHint&&(e.playoutDelayHint=h),void 0!==e.jitterBufferDelayHint&&(e.jitterBufferDelayHint=h)},getStats(){let e=this;this.pc.getStats().then((t=>{t.forEach((t=>{if("video"===t.mediaType&&"inbound-rtp"===t.type&&(e.videoStats=t,e.sendES("rtc_client_metrics",""),this.adjustPlayoutDelayFromStats(t)),"candidate-pair"===t.type&&t.nominated&&(this.dataChannelDelay=1e3*t.currentRoundTripTime,this.dataChannelDelay=this.dataChannelDelay>999?999:this.dataChannelDelay),"peer-connection"===t.type){this.startTime||(this.startTime=t.timestamp);let e=Math.floor((t.timestamp-this.startTime)/1e3/60);if(e>0&&e<31&&!this.liveTimeSet.includes(e)){this.liveTimeSet.push(e),gtag("event",`play_for_${e}_min`)}}}))})).catch((e=>{})),setTimeout((()=>{this.getStats()}),1e3)},reportCoordinator(){this.statesBWE&&(log.info(this.statesBWE),this.socket.emit("metrics","bwe:"+(this.statesBWE/1024/1024).toFixed(3)+";rtt:"+this.statesRTT+";fpsin:"+this.statesFpsIn+";fpssent:"+this.statesFpsSent+";txbitrate:"+(0).toFixed(3)+";encodeMs:0;touchcount:0;videoPaused:"+(this.$refs.remoteVideo&&this.$refs.remoteVideo.paused)+";foreground:true"),this.socket.emit("metrics","ice state: "+this.pc.iceConnectionState+" signaling state: "+this.pc.signalingState+" iceGatheringState: "+this.pc.iceGatheringState)),setTimeout((()=>{this.reportCoordinator()}),3e3)},changeOrientation(e){this.pingOrient(),this.inputOrient(),this.keyboardOrient(),this.menuOrient();const t=document.documentElement.clientHeight,i=document.documentElement.clientWidth;let s,o;const n=1===e,r=this.screenWidth/this.screenHeight;n?(s=t,o=Math.round(t/r),o>i&&(o=i,s=Math.round(i*r)),this.$refs.remoteWrapper.style.transform="rotate(270deg)"):0===e&&(s=i,o=Math.round(i/r),o>t&&(o=t,s=Math.round(t*r)),this.videoWidth=s,this.videoHeight=o,this.$refs.remoteWrapper.style.transform="rotate(0deg)",this.$refs.remoteWrapper.style.right="auto",this.$refs.remoteWrapper.style.bottom=Math.abs((s-o)/2)+""),this.videoWidth=s,this.videoHeight=o,1===this.rotation?(this.$refs.remoteVideo.style.width=this.videoHeight+"px",this.$refs.remoteVideo.style.height=this.videoWidth+"px",this.$refs.remoteCanvas.style.width=this.videoHeight+"px",this.$refs.remoteCanvas.style.height=this.videoWidth+"px"):(this.$refs.remoteVideo.style.width=this.videoWidth+"px",this.$refs.remoteVideo.style.height=this.videoHeight+"px",this.$refs.remoteCanvas.style.width=this.videoWidth+"px",this.$refs.remoteCanvas.style.height=this.videoHeight+"px");const a=!(1===this.rotation||n);this.keyRotate=a,this.iconRotate=t>i},reconnectStreaming(){log.info("!!! reconnectStreaming"),log.info("streaming: "+this.streamingOn+", getout = "+this.getout),this.streamingOn||this.getout||(this.socket&&(log.info("### close old socket if exists"),this.socket.close()),this.connectStreaming())},connectStreaming(){this.createPeerConnection(),this.connectSocket()},connectSocket(){this.listenKeyup(),this.listenKeydown();let e=this.getSocketUrl();if(gtag("event","socket_connecting"),"https://0.0.0.0"===e||null==e||""===e)return this.pushSteps("Failed to connect to the game"),void this.parentPostMessage({start_cloud_game:!1});this.socket=io(e,{reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:1e4,randomizationFactor:.5,path:"/client/socket.io",pingInterval:1e4,pingTimeout:2e4,transports:["websocket"]}),this.socketBind()},socketBind(){let e=this;this.socket.on("hello_server",(()=>{e.pushSteps("Server has been successfully connected"),e.joinRoom()})),this.socket.on("connect",(()=>{gtag("event","socket_connected"),e.pushSteps("Server has been found")})),this.socket.on("action_done2",(e=>{this.socket.emit("metrics","join room"),this.socket.emit("metrics","ready to join room"),this.socket.emit("register",{roomid:e.signalingRoomId,clientid:"1111111"})})),this.socket.on("msg",(t=>{if(clearTimeout(this.clientRegisterTimer),this.clientRegisterTimer=null,t.type)switch(t.type){case"offer":e.pushSteps("Waiting for screen connection"),gtag("event","receive_offer"),0!=this.codec_type&&(t.sdp=this.priorCodecType(t.sdp,this.codec_type)),"VP8"!==this.codec&&"H264"!==this.codec||(t.sdp=this.setMediaCodec(t.sdp,"video","receive",this.codec)),t.sdp=this.priorCodecType(t.sdp,100),t.sdp=this.insertRRTRBoth(t.sdp),this.oldOffer=t,this.pc.setRemoteDescription(new RTCSessionDescription(t)),this.createAnswer();break;case"answer":this.pc.setRemoteDescription(new RTCSessionDescription(t));break;case"candidate":this.pc.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:t.label,candidate:t.candidate}));break;case"leave":log.info("msg leave")}})),this.socket.on("no_free_android",(()=>{log.info("### no_free_android")})),this.socket.on("getout",(t=>(clearTimeout(this.clientRegisterTimer),this.clientRegisterTimer=null,this.streamingOn=!1,1===(t=JSON.parse(t)).errorCode&&this.pushSteps("Server busy, please restart from the game list"),10===t.errorCode?(e.pushSteps("Screen has been successfully connected"),gtag("event","receive_stream"),this.streamingOn=!0,void this.socket.close()):7===t.errorCode||11===t.errorCode?(log.info("Connection error, "+t.msg),this.pushSteps("Server busy, please restart from the game list"),void this.socket.close()):12===t.errorCode?(log.info("Connection error, "+t.msg),this.pushSteps("Connection failed, please restart from the game list"),void this.socket.close()):(this.sendES("user_interaction","connection_error"),void this.parentPostMessage({start_cloud_game:!1}))))),this.socket.on("error",(t=>{loading(),e.dataChannel.close(),e.pc.close(),e.createPeerConnection(),log.info("error:"+JSON.stringify(t))})),this.socket.on("disconnect",(e=>{log.info("disconnect:"+JSON.stringify(e))}))},insertRRTRBoth: e=>e.replace(/(m=video.*\r\n)/,"$1a=rtcp-xr:rrtr\r\n").replace(/(m=audio.*\r\n)/,"$1a=rtcp-xr:rrtr\r\n"),joinRoom(){"false"!==this.initParams.gameName&&null==this.game&&(this.game=this.initParams.gameName),this.pushSteps("Room has been joined");let e={screenRes:this.screenWidth+"x"+this.screenHeight,game:this.game,userId:this.userId,slotId:this.userId+"@"+this.game,instanceId:this.android_instance_id};this.socket.emit("client_register",e),this.socket.emit("metrics",navigator.userAgent)},createDataChannel(){let e=this.pc.createDataChannel("config",{ordered:!0,reliable:!0});e.onerror= e=>{log.info("Data Channel Error: "+e),this.socket&&this.socket.emit("metrics","data channel error")},e.onmessage= e=>{this.handleDCMessage(e.data)},e.onopen=()=>{log.info("Data Channel opened: "+e.readyState),"open"!==e.readyState?(e.close(),e=null,this.createDataChannel()):(this.dataChannel.send("res>"+this.screenWidth+"x"+this.screenHeight),this.getStats(),this.socket&&this.socket.emit("metrics","data channel open"))},e.onclose=()=>{log.info("Data Channel Closed"),this.pc.close(),this.pc=null,this.dataChannel=null,this.socket&&this.socket.emit("metrics","data channel closed"),this.sendES("user_interaction","connection_error"),this.streamingOn=!1,this.parentPostMessage({start_cloud_game:!1})},this.dataChannel=e},fullScreen(){const e=document.documentElement;e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()},exitFullScreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},handleDCMessage(msg){msg=msg.split(">"),"stats"!==msg[0]&&"inputDelay"!==msg[0]&&log.info("~~~",msg);let that=this;if("hide_cursor"===msg[0])this.exitingPointerLock||(this.cursorHide="1"===msg[1]);else if("rotation"===msg[0])removeLoading(),that.sendStartGame||(that.parentPostMessage({start_cloud_game:!0}),that.sendStartGame=!0),this.rotation=parseInt(msg[1]),this.rotateHandler();else if("touchState"===msg[0])this.enableTouch="true"===msg[1];else if("remotePay"===msg[0])window.android&&window.android.remotePay(msg[1]);else if("keyboard"===msg[0])"show"===msg[1]?(this.inputTextShow=!0,setTimeout((()=>{that.$refs.input.focus()}),100)):(this.inputTextShow=!1,this.inputTextStr="");else if("stats"===msg[0]){let e=msg[1].split(",");for(let t=0; t<e.length; t++){let i=e[t].split(":");if("googAvailableSendBandwidth"===i[0]){let e=i[1],t=Number(e).toLocaleString("fullwide",{useGrouping:!1});this.statesBWE=t}else"googTransmitBitrate"===i[0]?this.statesTxBitrate=i[1]:"googAvgEncodeMs"===i[0]?this.statesEncodeMs=i[1]:"googFrameRateInput"===i[0]?this.statesFpsIn=i[1]:"googFrameRateSent"===i[0]?this.statesFpsSent=i[1]:"googRtt"===i[0]?(this.statesRTT=i[1],Number(this.statesRTT)<0&&(this.statesRTT=0)):"googCodecName"===i[0]&&""!==i[1]?this.statesCodecName=i[1]:"googFrameWidthSent"===i[0]?this.statesFrameWidth=i[1]:"googFrameHeightSent"===i[0]?this.statesFrameHeight=i[1]:"bytesSent"===i[0]&&(this.statesBytesSent=i[1])}}else if("cloudData"===msg[0]){window.parent.postMessage(msg[1],"*");let j=eval("("+msg[1]+")");j.loading_done&&(this.loadingDoneTime=Date.now(),this.sendMetric("loading_done",{game:this.game,env:this.initParams.env,delay:this.loadingDoneTime-this.openPageTime}))}else"pod_name"===msg[0]?(this.podName=msg[1],log.info("%c podName","color: blue; font-size: 14px",this.podName)):"kickout"===msg[0]?(this.getout=!0,this.socket.close(),log.info("%c client kickout","color: red; font-size: 14px",msg[1])):"locale"===msg[0]&&(this.podLocale=msg[1])},pushSteps(e){document.getElementById("step-msg").textContent=e,log.info("%c%s","color: #939597; font-size: 14px",e),this.steps.push((new Date).getTime()+":"+e)},rotateHandler(){const e=document.documentElement.clientHeight,t=document.documentElement.clientWidth;let i=this.$refs.remoteVideo.offsetWidth,s=this.$refs.remoteVideo.offsetHeight;1===this.rotation?(this.$refs.remoteVideo.style.width=s+"px",this.$refs.remoteVideo.style.height=i+"px",this.$refs.remoteCanvas.style.width=s+"px",this.$refs.remoteCanvas.style.height=i+"px",this.isRotate=!0,this.$refs.remoteCanvas.style.transformOrigin=(this.screenWidth/this.screenHeight/2*100).toFixed(2)+"% center",this.$refs.remoteVideo.style.transformOrigin=(this.screenWidth/this.screenHeight/2*100).toFixed(2)+"% center",this.isRotateScreen=t<=e):(this.$refs.remoteVideo.style.width=i+"px",this.$refs.remoteVideo.style.height=s+"px",this.$refs.remoteCanvas.style.width=i+"px",this.$refs.remoteCanvas.style.height=s+"px",this.isRotate=!1,this.isRotateScreen=t>e),this.changeOrientation(this.direction)},parentPostMessage(e){let t=JSON.stringify(e);window.parent.postMessage(t,"*")},handleTrack(e){let t=this;log.info("handle track"),e.track.onunmute=()=>{if("video"===e.track.kind)t.$refs.remoteVideo.srcObject!==e.streams[0]&&(log.info("bind video"),t.streamingConnectedTime=Date.now(),t.sendMetric("streaming_connected",{game:t.game,env:t.initParams.env,delay:t.streamingConnectedTime-t.openPageTime}),t.$refs.remoteVideo.srcObject=e.streams[0],t.remoteStream=e.streams[0],t.receivers=this.pc.getReceivers(),t.pushSteps("Game stream has been received"),this.socket&&this.socket.emit("metrics","videostart"));else{if("audio"!==e.track.kind)return;log.info("bind audio"),t.$refs.remoteAudio.srcObject!==e.streams[0]&&(t.$refs.remoteAudio.srcObject=e.streams[0])}},setTimeout((function(){null==t.$refs.remoteVideo.srcObject&&t.$refs.remoteVideo.srcObject!==e.streams[0]&&(t.$refs.remoteVideo.srcObject=e.streams[0],t.remoteStream=e.streams[0],t.receivers=this.pc.getReceivers(),log.info("received remote stream by setTimeout"),this.socket&&this.socket.emit("metrics","videostart"))}),1e3)},startGame(){this.$refs.remoteVideo.paused&&(this.$refs.remoteVideo.play(),this.socket&&this.socket.emit("metrics","startVideo: paused remoteVideo")),this.$refs.remoteAudio.paused&&this.$refs.remoteAudio.play(),this.showPlayBtn=!1},guid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),createPeerConnection(){try{let e=this,t=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;this.pc=new t(this.pcConfiguration),this.pc.onicecandidate=this.handleIceCandidate,this.pc.oniceconnectionstatechange=function(){log.info("ice connection state:"+e.pc.iceConnectionState),gtag("event",`ice_connection_state_${e.pc.iceConnectionState}`)},this.pc.onconnectionstatechange=function(){log.info("connection state:"+e.pc.connectionState),"failed"===e.pc.connectionState&&(e.sendES("user_interaction","connection_error"),e.streamingOn=!1,e.parentPostMessage({start_cloud_game:!1}))},this.pc.onicegatheringstatechange=function(){log.info("ice gathering state:"+e.pc.iceGatheringState)},this.pc.onsignalingstatechange=function(){log.info("signaling state:"+e.pc.signalingState)},this.pc.ontrack=this.handleTrack,this.createDataChannel()}catch(e){this.parentPostMessage({start_cloud_game:!1}),log.info(e.message)}},rotateScreenDC(){void 0===this.scDirection&&(this.scDirection=this.direction,log.info("first scDirection")),log.info(this.scDirection),1===this.scDirection?(this.sendDataChannelMessage("sensor>accelerate:9.552746_0.4022933_1.6402799"),this.sendDataChannelMessage("sensor>rotate:0.56005067_-0.31531847_0.65358347_0.397583_0.0"),this.scDirection=0):(this.sendDataChannelMessage("sensor>accelerate:-0.56410795_9.483055_2.0590239"),this.sendDataChannelMessage("sensor>rotate:0.60119915_0.19365342_0.18520845_0.756958_0.0"),this.scDirection=1)},handleIceCandidate(e){if(e.candidate){let t={type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate};log.info("Start of candidates"+JSON.stringify(t)),this.sendMessage(t)}else log.info("End of candidates")},createAnswer(){this.pc.createAnswer().then((e=>{if(this.pushSteps("Local parameters has been set"),this.bitRate>0){var t=e.sdp.split("\r\n");t.forEach(((e, i)=>{/^a=fmtp:\d*/.test(e)?t[i]=e+";x-google-max-bitrate="+this.bitRate+";x-google-min-bitrate=1000;x-google-start-bitrate=1000":/^a=mid:(1|video)/.test(e)&&(t[i]+="\r\nb=AS:"+this.bitRate)})),e.sdp=t.join("\r\n")}let i=e.sdp;e.sdp=i,this.oldAnswer=e,this.pc.setLocalDescription(e),this.sendMessage(e)}),(e=>{log.info("!!! createAnswer errorï¼š"+e)}))},setMediaCodec(e, t, i, s){let o=t+" "+i+" codec";if(log.info("----------------------------------"),!s)return log.info("No preference on "+o+"."),e;log.info("Prefer "+o+": "+s);let n=e.split("\r\n"),r=-1;for(let e=0; e<n.length; e++)if(0===n[e].indexOf("m="+t)){r=e;break}if(-1===r)return e;let a=null;for(let e=0; e<n.length; e++){let t=this.findLineInRange(n,e,-1,"a=rtpmap",s);null!==t&&(a=this.getCodecPayloadTypeFromLine(n[t]),a&&(n[r]=this.setDefaultCodec(n[r],a)))}return e=n.join("\r\n")},findLineInRange(e, t, i, s, o){let n=-1!==i?i:e.length;for(let i=t; i<n; ++i)if(0===e[i].indexOf(s)&&(!o||-1!==e[i].toLowerCase().indexOf(o.toLowerCase())))return i;return null},getCodecPayloadTypeFromLine(e){let t=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+"),i=e.match(t);return i&&2===i.length?i[1]:null},setDefaultCodec(e, t){let i=e.split(" "),s=i.slice(0,3);s.push(t);for(let e=3; e<i.length; e++)i[e]!==t&&s.push(i[e]);return s.join(" ")},priorCodecType(e, t){let i=e.split("\r\n"),s=[];for(let e=0; e<i.length; e++)0===i[e].indexOf("m=video")&&(s[e]=e);return 0===s.length?e:(s.forEach((e=>{let s=i[e],o=s.split(" "),n=o.indexOf(t);for(; -1!==n;)o.splice(n,1),n=o.indexOf(t);let r=JSON.parse(JSON.stringify(o));o=((e, t, i)=>{r[t]=i;for(let i=t; i<e.length; i++)r[i+1]=e[i];return r})(o,3,JSON.stringify(t));const a=o.filter(((e, t, i)=>i.indexOf(e)===t));s=a.join(" "),i[e]=s})),e=i.join("\r\n"))},setMediaBitRate(e, t, i){let s=e.split("\r\n"),o=-1;for(let e=0; e<s.length; e++)if(0===s[e].indexOf("m="+t)){o=e;break}if(-1===o)return e;for(o++; 0===s[o].indexOf("i=")||0===s[o].indexOf("c=");)o++;if(0===s[o].indexOf("b"))return o[o]="b=AS:"+i,s.join("\r\n");let n=s.slice(0,o);return n.push("b=AS:"+i),n=n.concat(s.slice(o,s.length)),n.join("\r\n")},sendMessage(e){log.info("send:"+e,0),this.socket.emit("msg",e)},mouseup(e){this.$refs.remoteVideo.muted||(this.$refs.remoteVideo.muted=!1),this.$refs.remoteAudio.muted&&(this.$refs.remoteAudio.muted=!1);const t=document.getElementById("canvasCoc");if(document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t){let t="";if(0===e.button){t=`touch>Touch end:5,${this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].pointerLockCoordinate&&this.gameConfig[this.checkGame].pointerLockCoordinate.lClick||"1060,550"}`}else if(2===e.button){t=`touch>Touch end:9,${this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].pointerLockCoordinate&&this.gameConfig[this.checkGame].pointerLockCoordinate.rClick||"1180,620"}`}return void this.sendDataChannelMessage(t)}if(2===e.button){if(!(this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].supportRightClick))return;return void this.sendDataChannelMessage(`touch>Touch end:8,${Math.floor(this.dEyePosition.x)},${Math.floor(this.dEyePosition.y)}`)}if(!this.sendMove)return;this.sendMove=!1,this.$refs.remoteVideo.muted||(this.$refs.remoteVideo.muted=!1),this.$refs.remoteAudio.muted&&(this.$refs.remoteAudio.muted=!1);let i=`touch>Mouse up:${e.button},${this.resizeHandler(e.offsetX)},${this.resizeHandler(e.offsetY)}`;this.sendDataChannelMessage(i)},mousedown(e){const t=document.getElementById("canvasCoc");if(document.pointerLockElement===t||document.mozPointerLockElement===t||document.webkitPointerLockElement===t){let t="";if(0===e.button){t=`touch>Touch start:5,${this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].pointerLockCoordinate&&this.gameConfig[this.checkGame].pointerLockCoordinate.lClick||"1060,550"}`}else if(2===e.button){const e=this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].pointerLockCoordinate&&this.gameConfig[this.checkGame].pointerLockCoordinate.rClick||"1180,620";if("0,0"===e)return;t=`touch>Touch start:9,${e}`}return void this.sendDataChannelMessage(t)}if(this.sendMove=!0,2===e.button){if(!(this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].supportRightClick))return;return this.dEyePosition=this.gameConfig[this.checkGame].rightRockerPosition??{x:640,y:360},this.dEyeCenter=this.gameConfig[this.checkGame].rightRockerCenter??{x:640,y:360},void this.sendDataChannelMessage(`touch>Touch start:8,${this.dEyeCenter.x},${this.dEyeCenter.y}`)}let i=`touch>Mouse down:${e.button},${this.resizeHandler(e.offsetX)},${this.resizeHandler(e.offsetY)}`;this.sendDataChannelMessage(i)},mousemove(e){const t=document.getElementById("canvasCoc");if(document.pointerLockElement===t){const t=e.movementX??0,i=e.movementY??0;this.moveX+=t*this.mouseSensitivity,this.moveY+=i*this.mouseSensitivity;const s=this.$refs.remoteVideo.offsetWidth/2,o=this.$refs.remoteVideo.offsetHeight/2;this.moveX=Math.max(-s,Math.min(s,this.moveX)),this.moveY=Math.max(-o,Math.min(o,this.moveY));let n={x:640,y:360};const r=this.gameConfig[this.checkGame];if(r?.pointerLockCenter&&(n=r.pointerLockCenter),!this.pointerLockStart){let e=`touch>Touch start:8,${n.x},${n.y}`;this.sendDataChannelMessage(e),this.pointerLockStart=!0}let a=this.resizeHandler(this.moveX),h=this.resizeHandler(this.moveY),c=`touch>Touch move:8,${n.x+a},${n.y+h}`;return this.sendDataChannelMessage(c),this.resetMoveTimer&&clearTimeout(this.resetMoveTimer),void(this.resetMoveTimer=setTimeout((()=>{let e=`touch>Touch end:8,${n.x+a},${n.y+h}`;this.sendDataChannelMessage(e),this.moveX=0,this.moveY=0,this.pointerLockStart=!1}),200))}if(!this.sendMove)return;const i=2===e.buttons,s=0===e.button||this.alwaysSendMove,o=this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].supportRightClick;if(!o&&i)return;if(o&&i){let t=this.dEyePosition.x+e.movementX,i=this.dEyePosition.y+e.movementY;const s=t-this.dEyeCenter.x,o=i-this.dEyeCenter.y;if(Math.sqrt(s*s+o*o)>this.dEyeRadius){const e=Math.atan2(o,s);t=this.dEyeCenter.x+this.dEyeRadius*Math.cos(e),i=this.dEyeCenter.y+this.dEyeRadius*Math.sin(e)}return this.dEyePosition.x=t,this.dEyePosition.y=i,void this.sendDataChannelMessage(`touch>Touch move:8,${Math.floor(t)},${Math.floor(i)}`)}if(!s)return;this.last_move_event=e;let n=`touch>Mouse move:${e.button},${this.resizeHandler(e.offsetX)},${this.resizeHandler(e.offsetY)}`;this.sendDataChannelMessage(n)},mousewheel(e){this.mousewheelFakeAndroid(e)},mouseleave(e){this.sendMove&&this.mouseup(this.last_move_event)},mousewheelFakeAndroid(e){let t=e.wheelDelta;if(this.zoom){if(t<0){if(1===this.rotation)for(let e=0; e<=48; e+=16){let t="";t=0===e?"touch>Touch start:6,440,230:7,840,490":48===e?`touch>Touch end:6,${440+e},${230+e/16*5},:7,${840-e},${490-e/16*5}`:`touch>Touch move:6,${440+e},${230+e/16*5},:7,${840-e},${490-e/16*5}`,setTimeout((()=>{this.sendDataChannelMessage(t)}),2.5*e)}}else if(1===this.rotation)for(let e=0; e<=48; e+=16){let t="";t=0===e?"touch>Touch start:6,488,250:7,792,470":48===e?`touch>Touch end:6,${488-e},${250-e/16*5},:7,${792+e},${470+e/16*5}`:`touch>Touch move:6,${488-e},${250-e/16*5},:7,${792+e},${470+e/16*5}`,setTimeout((()=>{this.sendDataChannelMessage(t)}),2.5*e)}this.zoom=!1,setTimeout((()=>{this.zoom=!0}),300)}},getChangedTouchesString(e){let t="";for(let i=0; i<e.changedTouches.length; i++){let s=e.changedTouches[i],o=this.getMousePos(s.pageX,s.pageY);t+=":"+this.getTouchCounter(s.identifier)+","+o.x+","+o.y}return t},resizeHandler(e){let t=0,i=this.$refs.remoteVideo.offsetWidth,s=this.$refs.remoteVideo.offsetHeight;return t=i>s?this.initParams.screenWidth/i:this.initParams.screenWidth/s,this.scaleValue=t,Math.floor(e*t)},getMousePos(e, t){let i=document.documentElement.clientHeight,s=document.documentElement.clientWidth;return 0===this.direction?(t-=(i-this.videoHeight)/2,e-=(s-this.videoWidth)/2):(t-=(i-this.videoWidth)/2,e-=(s-this.videoHeight)/2),e=this.resizeHandler(e),t=this.resizeHandler(t),1===this.rotation&&0===this.direction?{x:Math.abs(t),y:Math.abs(e-this.screenWidth)}:1===this.rotation&&1===this.direction?{x:e,y:t}:0===this.rotation&&1===this.direction?{x:Math.abs(t-this.screenWidth),y:Math.abs(e)}:(0===this.rotation&&this.direction,{x:e,y:t})},touchstart(e){let t="touch>Touch start"+this.getChangedTouchesString(e);this.sendDataChannelMessage(t)},touchmove(e){this.$refs.remoteVideo.muted&&(this.$refs.remoteVideo.muted=!1),this.$refs.remoteAudio.muted&&(this.$refs.remoteAudio.muted=!1);let t="touch>Touch move"+this.getChangedTouchesString(e);this.sendDataChannelMessage(t)},touchend(e){this.$refs.remoteVideo.muted||(this.$refs.remoteVideo.muted=!1),this.$refs.remoteAudio.muted&&(this.$refs.remoteAudio.muted=!1);let t="touch>Touch end"+this.getChangedTouchesString(e);this.socket.emit("metrics","bwe;;;;;;touches:1"),this.sendDataChannelMessage(t)},touchcancel(e){let t="touch>Touch endcancel"+this.getChangedTouchesString(e);this.sendDataChannelMessage(t)},listenKey(e){if(!e.key)return;let t="touch>Text:"+e.key;1!==e.key.length&&(t="touch>TextCmd:"+e.key),log.info(t),this.sendDataChannelMessage(t)},listenKeyUp(e){if(!e.key)return;if(e.keyCode>=112&&e.keyCode<=123)return;if(e.preventDefault(),"`"===e.key)return;this.keyDownMap[e.key]=!1;let t="";!e.altKey&&this.keyDownMap.Alt&&(t="touch>KeyUpCmd:Alt",this.sendDataChannelMessage(t),this.keyDownMap.Alt=!1),!e.ctrlKey&&this.keyDownMap.Control&&(t="touch>KeyUpCmd:Control",this.sendDataChannelMessage(t),this.keyDownMap.Control=!1),!e.shiftKey&&this.keyDownMap.Shift&&(t="touch>KeyUpCmd:Shift",this.sendDataChannelMessage(t),this.keyDownMap.Shift=!1),!e.metaKey&&this.keyDownMap.Meta&&(t="touch>KeyUpCmd:Meta",this.sendDataChannelMessage(t),this.keyDownMap.Meta=!1);const i=this.gameConfig[this.checkGame];if(!i?.keyBoard)return;const s=e.key.toLowerCase(),o=e.code.toLowerCase();if(i.supportLeftRocker&&["w","a","s","d"].includes(s)&&(delete this.leftRockerPressedKeys[s],0===Object.keys(this.leftRockerPressedKeys).length)){let e=this.center;this.leftRockerEnd||(this.sendDataChannelMessage(`touch>Touch end:10,${e.x+Math.floor(this.leftRockerPosition.x)},${e.y+Math.floor(this.leftRockerPosition.y)}`),this.leftRockerPosition={x:0,y:0},this.leftRockerStart=!1,this.leftRockerEnd=!0)}if(i.supportRightRocker&&["z","x","c","v"].includes(s)&&(delete this.rightRockerPressedKeys[s],0===Object.keys(this.rightRockerPressedKeys).length)){let e=this.gameConfig[this.checkGame].rightCenter;this.rightRockerEnd||(this.sendDataChannelMessage(`touch>Touch end:11,${e.x+Math.floor(this.rightRockerPosition.x)},${e.y+Math.floor(this.rightRockerPosition.y)}`),this.rightRockerPosition={x:0,y:0},this.rightRockerStart=!1,this.rightRockerEnd=!0)}(document.querySelector(`.keyboard-key-${s}`)||document.querySelector(`.keyboard-key-${o}`))?.classList.remove("keyboard-key-press");const n=i.keyBoard[s]?.coordinate;if(n&&"0,0"!==n){const e=this.getTouchCounter(s);this.sendDataChannelMessage(`touch>Touch end:${e},${n}`)}},listenKeyDown(e){if(!e.key)return;if(e.keyCode>=112&&e.keyCode<=123)return;const t=e.target.tagName.toLowerCase(),i=e.target.isContentEditable;if("input"===t||"textarea"===t||i)return;if(e.preventDefault(),e.ctrlKey&&77===e.keyCode)return void(this.gameConfig[this.checkGame]&&this.gameConfig[this.checkGame].pointerLock&&this.pointerLock());if(this.lastKeyDownCode=e.keyCode,this.lastKeyDownTime=(new Date).getTime(),this.keyDownMap[e.key])return;this.keyDownMap[e.key]=!0;const s=this.gameConfig[this.checkGame];if(!s?.keyBoard)return;const o=e.key.toLowerCase(),n=e.code.toLowerCase();s.supportLeftRocker&&["w","a","s","d"].includes(o)&&(this.leftRockerPressedKeys[o]=!0),s.supportRightRocker&&["z","x","c","v"].includes(o)&&(this.rightRockerPressedKeys[o]=!0);(document.querySelector(`.keyboard-key-${o}`)||document.querySelector(`.keyboard-key-${n}`))?.classList.add("keyboard-key-press");const r=s.keyBoard[o]?.coordinate;if(r&&"0,0"!==r){const e=this.getTouchCounter(o);this.sendDataChannelMessage(`touch>Touch start:${e},${r}`)}},listenKeyup(){document.addEventListener("keyup",this.listenKeyUp)},listenKeyupDestroyed(){document.removeEventListener("keyup",this.listenKeyUp)},listenKeydown(){document.addEventListener("keydown",this.listenKeyDown)},listenKeydownDestroyed(){document.removeEventListener("keydown",this.listenKeyDown)},sendDataChannelMessage(e){"true"===params.get("show_datachannel_msg")&&log.info("%cDataChannel: ","color: blue; font-size: 14px",e),this.pc&&this.dataChannel&&"open"===this.dataChannel.readyState&&(this.$refs.remoteVideo.paused&&this.$refs.remoteVideo.play(),this.$refs.remoteAudio.paused&&this.$refs.remoteAudio.play(),this.dataChannel.send(e))},inputOrient(){let e=document.documentElement.clientWidth,t=document.documentElement.clientHeight,i=document.getElementById("input-div");e>=t?(i.style.transform="rotate(0)",i.style.left="0",i.style.bottom="20px",i.style.right="",i.style.top=""):(i.style.transform="rotate(90deg)",i.style.left="-75%",i.style.right="0",i.style.top="50%",i.style.bottom="50%")},pingOrient(){let e=document.documentElement.clientWidth,t=document.documentElement.clientHeight,i=document.getElementById("ping");if(e>=t)i.style.transform="rotate(0)",i.style.left="0",i.style.bottom="0%",i.style.width=e+"px";else{i.style.transform="rotate(90deg)",i.style.width=t+"px";let e=16,s=t;i.style.left="-"+(s-e)/2+"px",i.style.bottom=t-(s+e)/2+"px"}},keyboardOrient(){let e=document.getElementById("keyboard");1===this.direction?(e.style.transform="rotate(0)",e.style.left="0",e.style.right="0",e.style.top="0",e.style.bottom="0"):(e.style.transform="translate(-50%, -50%) rotate(90deg)",e.style.left="50%",e.style.right="",e.style.top="50%",e.style.bottom="")},menuOrient(){let e=document.documentElement.clientWidth,t=document.documentElement.clientHeight,i=document.getElementById("menu");e>=t?(i.style.transform="rotate(0)",i.style.left="0",i.style.right="0",i.style.top="0",i.style.bottom="0",i.style.width="100%",i.style.height="100%"):(i.style.transform="translate(-50%, -50%) rotate(90deg)",i.style.left="50%",i.style.top="50%",i.style.right="",i.style.bottom="",i.style.width="100vh",i.style.height="100vw")},getTouchCounter(e){return this.touchIdMap.has(e)||this.touchIdMap.set(e,this.touchCounter++),this.touchIdMap.get(e)},getUTCDate(){const e=new Date,[t,i,s,o,n,r]=[e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()].map((e=>String(e).padStart(2,"0")));this.utcDate=`${t}-${i}-${s} ${o}:${n}:${r}`}}});